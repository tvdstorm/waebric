
ometa Waebric <: Parser {

  Modules         = Module*,
  Module          = "module" space ModuleId space ModuleElement spaces end,
  ModuleId        = IdCon ("." IdCon)*,
  ModuleElement   = FunctionDef
                  | Import
                  | Site,
  
  FunctionDef     = "def" IdCon Formals? Statement* "end",
  Formals         = "(" (Var ",")* ")",
  Statement       = "if" "(" Predicate ")" Statement
                  | "if" "(" Predicate ")" Statement "else" Statement
                  | "each" "(" Var ":" Expression ")" Statement
                  | "let" Assignment+ "in" Statement* "end"
                  | "{" Statement* "}"
                  | "comment" StrCon ","
                  | "echo" Expression ";"
                  | "cdata" Expression ";"
                  | "yield" ";"
                  | Markup+ Statement
                  | Markup ";"
                  | Markup+ Markup ";"
                  | Markup+ Expression ";"
                  | Markup+ Embedding ";"

  Import          = spaces,

  Site            = "site" spaces Mappings spaces "end",
  Mappings        = listOf(#Mapping, ';'),
  Mapping         = Path spaces ":" spaces Markup,
  Path            = IdCon "." IdCon,
  Markup          = Designator Arguments
                  | Designator, 
  Arguments       = "(" listOf(#Argument, ',') ")",
  Argument        = Expression
                  | Var "=" Expression,
  Expression      = Var 
                  | SymbolCon
                  | NatCon
                  | Expression "." IdCon
                  | "[" listof(#Expression ',') "]"
                  | "{" listof(#KeyValuePair ',') "}",
  KeyValuePair    = IdCon ":" Expression,
  Designator      = IdCon,
  Attribute       = ("#" | "." | "$" | ":") IdCon
                  | "@" w:NatCon "%" h:NatCon
                  | "@" w:NatCon,
  Var             = IdCon,
  IdCon           = letterOrDigit+ | "module" | "import" | "def" | "end" | "site",
  NatCon          = digit+,
  SymbolCon       = "'" SymbolChar "'",
  SymbolChar      = letterOrDigit+
  
}

program = "
           module homepage

           site
             index.html:home('Bonjour')
           end
          "
alert(Waebric.matchAll(program, "Modules"))